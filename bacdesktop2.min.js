var DesktopClient=Stapes.subclass({constructor:function(t){this.triggerLinkId="BACDesktop"+(new Date).getTime(),this.modalId=this.triggerLinkId+"modal",this.modalWarningId=this.triggerLinkId+"warning",this.endpoint="",this.bootstrapSupport=!0,this.debug=!1,t&&(void 0!==t.bootstrapSupport&&(this.bootstrapSupport=t.bootstrapSupport),void 0!==t.endpoint&&(this.endpoint=t.endpoint),void 0!==t.debug&&(this.debug=t.debug)),this.log("BACDesktop [endpoint] : "+this.endpoint),this.log("BACDesktop [bootstrapSupport] : "+this.bootstrapSupport),$("body").append($("<a id='"+this.triggerLinkId+"' href='#'></a>")),this.bootstrapSupport?($("body").append(this.createModal()),$("body").append(this.createWarningModal())):($("body").append(this.createjQueryModal()),$(".overlay").css({position:"fixed",top:"0",bottom:"0",left:"0",right:"0","background-color":"black",opacity:"0.5","z-index":"1001","text-align":"center"}),$(".overlay-message").css({position:"fixed",display:"inline-block",top:"30px",left:"30px",width:"350px",height:"250px","background-color":"#fff",opacity:"1","z-index":"1002","border-radius":"10px","padding-top":"10px"}),$(".overlay, .overlay-message").hide())},dispatchCallback:function(t,e){t&&t.call(this,e)},validateEndpoint:function(){var t=!0;return this.endpoint||(alert("Por favor especificar la direccion del backend de BAC Desktop."),t=!1),t},log:function(t){this.debug&&console.log("DEBUG :: "+t)},clear:function(){this.bootstrapSupport&&($("#"+this.modalWarningId).modal("hide"),$("#"+this.modalId).modal("hide")),$("body").removeClass("modal-open"),$(".overlay, .overlay-message").hide(),$(".modal-backdrop").remove()},status:function(t){var e=this;this.validateEndpoint()&&(this.bootstrapSupport&&$("#"+this.modalId).modal({backdrop:"static",keyboard:!1}),$("#"+this.triggerLinkId).attr("href","bacdesktop2:status"),document.getElementById(this.triggerLinkId).click(),setTimeout(function(){e.clear(),e.dispatchCallback(t,"Estado de BAC Desktop solicitado. Verificar el resultado en la herramienta.")},3e3))},sendRequest:function(e,a){if(this.validateEndpoint()){e||this.dispatchCallback(a),e.module||this.dispatchCallback(a),e.operationCode||this.dispatchCallback(a),e.userName||this.dispatchCallback(a),e.tramitId||(e.tramitId=(new Date).getTime()),e.endpoint=this.endpoint;var o=!1;void 0!==e.avoidWaitingforAnswer&&(o=e.avoidWaitingforAnswer);var t=!0;if(void 0!==e.modal&&(t=e.modal),this.bootstrapSupport&&t){var i=e.modalType;i?"spinner"===i?($("#"+this.modalId+" .desktopInfoText").hide(),$("#"+this.modalId).modal({backdrop:"static",keyboard:!1})):"info"===i&&($("#"+this.modalId+" .desktopInfoText").show(),$("#"+this.modalId).modal({backdrop:"static",keyboard:!1})):($("#"+this.modalId+" .desktopInfoText").show(),$("#"+this.modalId).modal({backdrop:"static",keyboard:!1}))}else t&&$(".overlay, .overlay-message").show();var s=JSON.stringify(e),r=s.replace(/"/g,'\\"');r='"'+r+'"',r=window.btoa(r);var d=this,n={requestStr:s,requestStrBase64:r};this.saveRequest(d,"/bacdesktop/saveRequest.m",n,function(t){"error"!=t?($("#"+d.triggerLinkId).attr("href","bacdesktop2:"+r),document.getElementById(d.triggerLinkId).click(),o?setTimeout(function(){d.clear()},3e3):setTimeout(function(){d.getResponse(e,function(t){d.bootstrapSupport&&$("#"+this.modalId).modal("hide"),t&&"error"!==t.resultCode||d.bootstrapSupport&&$("#"+this.modalWarningId).modal(),d.dispatchCallback(a,t)})},2e3)):(d.clear(),d.dispatchCallback(a))})}},getResponse:function(t,e){this.waitForAnswer(t,0,e)},waitForAnswer:function(a,o,i){var s=this,r=(a.module,a.tramitId),d={resultCode:"fail"};if(250<=o)return s.dispatchCallback(i,d),!1;s=this;var t="tramitId="+a.tramitId;this.retrieveAnswer(this,"/bacdesktop/getResponse.m",t,function(t){try{if(t)if("error"===t)s.log("BACDesktop ["+r+"] : Invalid response!"),s.clear(),s.dispatchCallback(i,d);else{s.log("BACDesktop ["+r+"] : Response found!"),s.clear();try{var e=JSON.parse(t);d.resultCode=e.resultCode,d.resultContent=e}catch(t){console.log("BACDesktop ["+r+"] : "+t)}s.dispatchCallback(i,d)}else o<60?setTimeout(function(){o++,s.log("BACDesktop ["+r+"] : Retying response query...("+o+")"),s.waitForAnswer(a,o,i)},2e3):s.dispatchCallback(i,d)}catch(t){console.log("BACDesktop ["+r+"] : "+t),s.clear(),s.dispatchCallback(i)}})},saveBatchRequest:function(t,e){var a=JSON.stringify(t);$.ajax({url:"http://localhost:8080/desktop",type:"POST",crossDomain:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},data:{message:a},success:function(t){e.call(this,t)},error:function(t){e.call(this,{result:!1})}})},retrieveAnswer:function(t,e,a,o){var i=this,s=this.endpoint+e+"?"+a;return $.ajax({url:s,cache:!1,global:!1,type:"GET",timeout:1e4,async:!0,success:function(t){i.dispatchCallback(o,t?t.result:"error")},error:function(t,e,a){console.log("BACDesktop [NETWORK] : Error! "+e+","+t.responseText),i.dispatchCallback(o,"error")}})},saveRequest:function(t,e,a,o){var i=this;a||(a="");var s=this.endpoint+e;return jQuery.support.cors=!0,$.ajax({url:s,data:a,cache:!1,dataType:"json",timeout:1e4,crossDomain:!0,global:!1,type:"POST",contentType:"application/x-www-form-urlencoded;charset=utf-8",async:!0,success:function(t){i.dispatchCallback(o,t?t.result:"error")},error:function(t,e,a){console.log("BACDesktop [NETWORK] : Error! "+e+","+t.responseText),i.dispatchCallback(o,"error")}})},createModal:function(){var t=this.endpoint+"/views/plugins/common/bacdesktop/img/desktoploader.gif",e=this.endpoint+"/views/plugins/common/bacdesktop/img/arrow.png",a="";return a+='<div class="modal fade" id="'+this.modalId+'" role="dialog">',a+='    <div class="modal-dialog modal-sm">',a+='        <div class="modal-content">',a+='            <div class="modal-body">',a+='                <p style="text-align:center;padding-bottom:10px;padding-top:10px;"><img src="'+t+'" /></p><div class="well desktopInfoText" style="padding:20px;"><p>Se le solicitar&aacute; la informaci&oacute;n necesaria en el panel auxiliar que aparece en la parte inferior de su pantalla.</p><p>Una vez finalizado, podr&aacute; continuar con el flujo normal en la p&aacute;gina actual.</p><p class="pull-right"><img width="103" height="120" src="'+e+'" /></p></div>',a+="            </div>",a+="        </div>",a+="    </div>",a+=" </div>",a+="</div>"},createWarningModal:function(){var t="";return t+='<div class="modal fade" id="'+this.modalWarningId+'" role="dialog">',t+='    <div class="modal-dialog modal-sm">',t+='        <div class="modal-content">',t+='            <div class="modal-body">',t+='                <div class="well" style="padding:20px;"><p>No se obtuvo respuesta en el tiempo esperado del BAC Desktop por favor vuelva a intentarlo. Si tiene un panel de BAC Desktop abierto, por favor cerrarlo.</p><p>Puede continuar con el flujo normal en la p&aacute;gina actual.</p></div>',t+="            </div>",t+="        </div>",t+="    </div>",t+=" </div>",t+="</div>"},createjQueryModal:function(){var t=this.endpoint+"/views/plugins/common/bacdesktop/img/desktoploader.gif";this.endpoint;return'<div class="overlay"></div><div class="overlay-message"><p style="text-align:center;padding-bottom:10px;padding-top:10px;"><img src="'+t+'" /></p><div class="desktopInfoText" style="padding:20px;"><p>Se le solicitar&aacute; la informaci&oacute;n necesaria en el panel auxiliar que aparece en la parte inferior de su pantalla.</p><p>Una vez finalizado, podr&aacute; continuar con el flujo normal en la p&aacute;gina actual.</p><br>&nbsp;</div>'}});